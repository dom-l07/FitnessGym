<!DOCTYPE html>
<html>
<head>
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <%- include('../../partials/navbar') %>

    <div class="container-fluid py-4">
        <div class="row">
            <!-- Sidebar -->
            <%- include('../../partials/adminSidebar', { currentPage: 'rooms' }) %>

            <!-- Main Content -->
            <div class="col-md-10">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-primary fw-bold mb-0">
                        <i class="bi bi-door-open me-2"></i>Manage Rooms
                    </h2>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRoomModal">
                        <i class="bi bi-plus-circle me-2"></i>Add New Room
                    </button>
                </div>

                <!-- Success/Error Messages -->
                <% if (typeof messages !== 'undefined' && messages && messages.length > 0) { %>
                    <div class="alert alert-success border-0 rounded-3 mb-4">
                        <% messages.forEach(function(message) { %>
                            <p class="mb-0"><i class="bi bi-check-circle-fill me-2"></i><%= message %></p>
                        <% }); %>
                    </div>
                <% } %>

                <% if (typeof errors !== 'undefined' && errors && errors.length > 0) { %>
                    <div class="alert alert-danger border-0 rounded-3 mb-4">
                        <% errors.forEach(function(error) { %>
                            <p class="mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i><%= error %></p>
                        <% }); %>
                    </div>
                <% } %>

                <!-- Search and Filter Section -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text bg-primary text-white">
                                        <i class="bi bi-search"></i>
                                    </span>
                                    <input type="text" id="roomSearchInput" class="form-control" placeholder="Search rooms by name, type, or location...">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select id="locationFilter" class="form-select">
                                    <option value="">All Locations</option>
                                    <% if (locations && locations.length > 0) { %>
                                        <% locations.forEach(function(location) { %>
                                            <option value="<%= location.location_id %>"><%= location.name %></option>
                                        <% }); %>
                                    <% } %>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                    <i class="bi bi-arrow-counterclockwise"></i> Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card border-0 bg-primary text-white">
                            <div class="card-body text-center">
                                <h4 class="fw-bold"><%= rooms ? rooms.length : 0 %></h4>
                                <p class="mb-0">Total Rooms</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 bg-success text-white">
                            <div class="card-body text-center">
                                <h4 class="fw-bold"><%= rooms ? rooms.filter(r => r.room_name.toLowerCase() === 'cardio').length : 0 %></h4>
                                <p class="mb-0">Cardio Rooms</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 bg-warning text-white">
                            <div class="card-body text-center">
                                <h4 class="fw-bold"><%= rooms ? rooms.filter(r => r.room_name.toLowerCase() === 'strength').length : 0 %></h4>
                                <p class="mb-0">Strength Rooms</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 bg-info text-white">
                            <div class="card-body text-center">
                                <h4 class="fw-bold"><%= rooms ? rooms.filter(r => r.room_name.toLowerCase() === 'zumba').length : 0 %></h4>
                                <p class="mb-0">Zumba Rooms</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rooms Table -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0 text-primary">
                            <i class="bi bi-table me-2"></i>Rooms List
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="roomsTable">
                                <thead class="table-primary">
                                    <tr>
                                        <th>Room ID</th>
                                        <th>Room Name</th>
                                        <th>Location</th>
                                        <th>Capacity</th>
                                        <th>Image</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (rooms && rooms.length > 0) { %>
                                        <% rooms.forEach(function(room) { 
                                            const typeInfo = {
                                                'cardio': { color: 'danger', icon: 'bi-heart-pulse' },
                                                'strength': { color: 'warning', icon: 'bi-lightning-charge' },
                                                'zumba': { color: 'success', icon: 'bi-music-note-beamed' }
                                            };
                                            const roomType = room.room_name.toLowerCase();
                                            const info = typeInfo[roomType] || { color: 'primary', icon: 'bi-door-open' };
                                        %>
                                            <tr class="room-row" data-room-name="<%= room.room_name.toLowerCase() %>" data-location-id="<%= room.location_id %>" data-location-name="<%= room.location_name.toLowerCase() %>">
                                                <td><%= room.room_id %></td>
                                                <td>
                                                    <span class="badge bg-<%= info.color %> me-2">
                                                        <i class="<%= info.icon %> me-1"></i><%= room.room_name %>
                                                    </span>
                                                </td>
                                                <td>
                                                    <i class="bi bi-geo-alt text-primary me-1"></i>
                                                    <%= room.location_name %>
                                                </td>
                                                <td>
                                                    <span class="badge bg-light text-dark">
                                                        <i class="bi bi-people me-1"></i><%= room.capacity %> people
                                                    </span>
                                                </td>
                                                <td>
                                                    <img src="/images/roomsImg/<%= room.room_name.toLowerCase() %>/<%= room.image %>" 
                                                         alt="<%= room.room_name %>" 
                                                         class="img-thumbnail" 
                                                         style="width: 50px; height: 50px; object-fit: cover;">
                                                </td>
                                                <td>
                                                    <div class="btn-group" role="group">
                                                        <button type="button" class="btn btn-sm btn-outline-info" 
                                                                onclick="viewRoom('<%= room.room_id %>')"
                                                                title="View Details">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-warning" 
                                                                onclick="editRoom('<%= room.room_id %>')"
                                                                title="Edit Room">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                                onclick="deleteRoom('<%= room.room_id %>', '<%= room.room_name %>')"
                                                                title="Delete Room">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="6" class="text-center py-4">
                                                <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                                                <p class="text-muted mt-2 mb-0">No rooms found</p>
                                            </td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Room Modal -->
    <div class="modal fade" id="addRoomModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle me-2"></i>Add New Room
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form action="/admin/rooms/add" method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="addRoomName" class="form-label">Room Type *</label>
                            <select class="form-select" id="addRoomName" name="roomName" required>
                                <option value="">Select Room Type</option>
                                <option value="Cardio">Cardio</option>
                                <option value="Strength">Strength</option>
                                <option value="Zumba">Zumba</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="addLocationId" class="form-label">Location *</label>
                            <select class="form-select" id="addLocationId" name="locationId" required>
                                <option value="">Select Location</option>
                                <% if (locations && locations.length > 0) { %>
                                    <% locations.forEach(function(location) { %>
                                        <option value="<%= location.location_id %>"><%= location.name %></option>
                                    <% }); %>
                                <% } %>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="addCapacity" class="form-label">Capacity *</label>
                            <input type="number" class="form-control" id="addCapacity" name="capacity" min="1" max="100" required>
                        </div>
                        <div class="mb-3">
                            <label for="addRoomImage" class="form-label">Room Image</label>
                            <input type="file" class="form-control" id="addRoomImage" name="roomImage" accept="image/*">
                            <small class="text-muted">Optional: Upload an image for the room</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-1"></i>Add Room
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Room Modal -->
    <div class="modal fade" id="viewRoomModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-eye me-2"></i>Room Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="viewRoomContent">
                    <!-- Content will be loaded via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Room Modal -->
    <div class="modal fade" id="editRoomModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil me-2"></i>Edit Room
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editRoomForm" method="POST" enctype="multipart/form-data">
                    <div class="modal-body" id="editRoomContent">
                        <!-- Content will be loaded via AJAX -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-check-circle me-1"></i>Update Room
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteRoomModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>Confirm Deletion
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this room?</p>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This action cannot be undone. All related classes will also be affected.
                    </div>
                    <p><strong>Room:</strong> <span id="deleteRoomName"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form id="deleteForm" method="POST" style="display: inline;">
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-trash me-1"></i>Delete Room
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Search and filter functionality
        document.getElementById('roomSearchInput').addEventListener('input', function() {
            filterRooms();
        });

        document.getElementById('locationFilter').addEventListener('change', function() {
            filterRooms();
        });

        function filterRooms() {
            const searchTerm = document.getElementById('roomSearchInput').value.toLowerCase();
            const locationFilter = document.getElementById('locationFilter').value;
            const rows = document.querySelectorAll('.room-row');

            rows.forEach(row => {
                const roomName = row.getAttribute('data-room-name');
                const locationName = row.getAttribute('data-location-name');
                const locationId = row.getAttribute('data-location-id');

                const matchesSearch = !searchTerm || 
                    roomName.includes(searchTerm) || 
                    locationName.includes(searchTerm);
                
                const matchesLocation = !locationFilter || locationId === locationFilter;

                if (matchesSearch && matchesLocation) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function clearFilters() {
            document.getElementById('roomSearchInput').value = '';
            document.getElementById('locationFilter').value = '';
            filterRooms();
        }

        // Room management functions
        function viewRoom(roomId) {
            fetch(`/admin/rooms/${roomId}/details`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const room = data.room;
                        const content = `
                            <div class="row">
                                <div class="col-md-6">
                                    <img src="/images/roomsImg/${room.room_name.toLowerCase()}/${room.image}" 
                                         alt="${room.room_name}" 
                                         class="img-fluid rounded">
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-primary">Room Information</h6>
                                    <p><strong>Room ID:</strong> ${room.room_id}</p>
                                    <p><strong>Room Type:</strong> ${room.room_name}</p>
                                    <p><strong>Location:</strong> ${room.location_name}</p>
                                    <p><strong>Capacity:</strong> ${room.capacity} people</p>
                                    <p><strong>Created:</strong> ${new Date(room.created_at).toLocaleDateString()}</p>
                                </div>
                            </div>
                        `;
                        document.getElementById('viewRoomContent').innerHTML = content;
                        new bootstrap.Modal(document.getElementById('viewRoomModal')).show();
                    } else {
                        alert('Error loading room details: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading room details');
                });
        }

        function editRoom(roomId) {
            fetch(`/admin/rooms/${roomId}/edit-data`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const room = data.room;
                        const locations = data.locations;
                        
                        let locationOptions = '';
                        locations.forEach(location => {
                            const selected = location.location_id === room.location_id ? 'selected' : '';
                            locationOptions += `<option value="${location.location_id}" ${selected}>${location.name}</option>`;
                        });

                        const content = `
                            <div class="mb-3">
                                <label for="editRoomName" class="form-label">Room Type *</label>
                                <select class="form-select" id="editRoomName" name="roomName" required>
                                    <option value="Cardio" ${room.room_name === 'Cardio' ? 'selected' : ''}>Cardio</option>
                                    <option value="Strength" ${room.room_name === 'Strength' ? 'selected' : ''}>Strength</option>
                                    <option value="Zumba" ${room.room_name === 'Zumba' ? 'selected' : ''}>Zumba</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editLocationId" class="form-label">Location *</label>
                                <select class="form-select" id="editLocationId" name="locationId" required>
                                    ${locationOptions}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editCapacity" class="form-label">Capacity *</label>
                                <input type="number" class="form-control" id="editCapacity" name="capacity" 
                                       value="${room.capacity}" min="1" max="100" required>
                            </div>
                            <div class="mb-3">
                                <label for="editRoomImage" class="form-label">Room Image</label>
                                <input type="file" class="form-control" id="editRoomImage" name="roomImage" accept="image/*">
                                <small class="text-muted">Leave empty to keep current image</small>
                                <div class="mt-2">
                                    <img src="/images/roomsImg/${room.room_name.toLowerCase()}/${room.image}" 
                                         alt="Current image" class="img-thumbnail" style="width: 100px;">
                                </div>
                            </div>
                        `;
                        
                        document.getElementById('editRoomContent').innerHTML = content;
                        document.getElementById('editRoomForm').action = `/admin/rooms/${roomId}/update`;
                        new bootstrap.Modal(document.getElementById('editRoomModal')).show();
                    } else {
                        alert('Error loading room data: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading room data');
                });
        }

        function deleteRoom(roomId, roomName) {
            document.getElementById('deleteRoomName').textContent = roomName;
            document.getElementById('deleteForm').action = `/admin/rooms/${roomId}/delete`;
            new bootstrap.Modal(document.getElementById('deleteRoomModal')).show();
        }
    </script>
</body>
</html>
