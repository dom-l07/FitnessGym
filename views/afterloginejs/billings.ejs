<!DOCTYPE html>
<html>
<head>
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <%- include('../partials/navbar') %>

    <div class="container py-5">
        <div class="row">
            <div class="col-md-12">
                <h1 class="h3 text-primary fw-bold mb-4">Billing & Payments</h1>
                
                <% if (messages && messages.length > 0) { %>
                    <div class="alert alert-success rounded-3 mb-4">
                        <% messages.forEach(function(message) { %>
                            <p class="mb-0"><i class="bi bi-check-circle-fill me-2"></i><%= message %></p>
                        <% }); %>
                    </div>
                <% } %>
                
                <% if (errors && errors.length > 0) { %>
                    <div class="alert alert-danger rounded-3 mb-4">
                        <% errors.forEach(function(error) { %>
                            <p class="mb-0"><i class="bi bi-exclamation-circle-fill me-2"></i><%= error %></p>
                        <% }); %>
                    </div>
                <% } %>

                <!-- Payment Methods Section -->
                <div class="row g-4 mb-5">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-credit-card me-2"></i>Payment Methods</h5>
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addPaymentMethodModal">
                                        <i class="bi bi-plus-circle me-1"></i>Add
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div id="paymentMethodsList" style="max-height: 200px; overflow-y: auto;">
                                    <% if (paymentMethods && paymentMethods.length > 0) { %>
                                        <% paymentMethods.forEach(function(method, index) { %>
                                            <div class="d-flex align-items-center justify-content-between p-3 payment-method-item <%= index < paymentMethods.length - 1 ? 'border-bottom' : '' %>">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-<%= method.method_type === 'Credit Card' ? 'credit-card' : method.method_type === 'Debit Card' ? 'credit-card-2-back' : method.method_type === 'PayPal' ? 'paypal' : 'bank' %> me-3 text-primary"></i>
                                                    <div>
                                                        <div class="fw-medium"><%= method.method_type %></div>
                                                        <% if (method.card_number_last4) { %>
                                                            <small class="text-muted">â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ <%= method.card_number_last4 %></small>
                                                        <% } %>
                                                        <% if (method.paypal_email) { %>
                                                            <small class="text-muted"><%= method.paypal_email %></small>
                                                        <% } %>
                                                        <% if (method.bank_name) { %>
                                                            <small class="text-muted"><%= method.bank_name %></small>
                                                        <% } %>
                                                        <% if (method.is_default) { %>
                                                            <span class="badge bg-success ms-2">Default</span>
                                                        <% } %>
                                                    </div>
                                                </div>
                                                <div>
                                                    <% if (!method.is_default) { %>
                                                        <form method="POST" action="/billing/payment-methods/<%= method.payment_method_id %>/set-default" style="display: inline;">
                                                            <button type="submit" class="btn btn-sm btn-outline-primary me-1">
                                                                Set Default
                                                            </button>
                                                        </form>
                                                    <% } %>
                                                    <form method="POST" action="/billing/payment-methods/<%= method.payment_method_id %>/delete" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this payment method?')">
                                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        <% }); %>
                                    <% } else { %>
                                        <div class="text-center py-4">
                                            <div class="display-6 text-muted mb-3">ðŸ’³</div>
                                            <p class="text-muted">No payment methods added yet</p>
                                            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addPaymentMethodModal">
                                                Add Payment Method
                                            </button>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-wallet me-2"></i>Account Balance</h5>
                                <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addFundsModal">
                                    <i class="bi bi-plus-circle me-1"></i>Add Funds
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="text-center py-4">
                                    <h2 class="text-success fw-bold">$<%= wallet ? parseFloat(wallet.balance).toFixed(2) : '0.00' %></h2>
                                    <p class="text-muted">Current Balance</p>
                                    <% if (paymentMethods && paymentMethods.length > 0) { %>
                                        <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#addFundsModal">
                                            Add Funds
                                        </button>
                                    <% } else { %>
                                        <p class="text-muted small">Add a payment method to add funds</p>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="card mb-5">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Transactions</h5>
                    </div>
                    <div class="card-body">
                        <% if (transactions && transactions.length > 0) { %>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Description</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% transactions.forEach(function(transaction) { %>
                                            <tr>
                                                <td><%= new Date(transaction.transaction_date).toLocaleDateString() %></td>
                                                <td>
                                                    <span class="badge bg-<%= transaction.transaction_type === 'Add Funds' ? 'success' : transaction.transaction_type === 'Payment' ? 'primary' : 'info' %>">
                                                        <%= transaction.transaction_type %>
                                                    </span>
                                                </td>
                                                <td><%= transaction.description || '-' %></td>
                                                <td class="<%= transaction.transaction_type === 'Add Funds' || transaction.transaction_type === 'Refund' ? 'text-success' : 'text-danger' %>">
                                                    <%= transaction.transaction_type === 'Add Funds' || transaction.transaction_type === 'Refund' ? '+' : '-' %>$<%= Math.abs(transaction.amount).toFixed(2) %>
                                                </td>
                                                <td>
                                                    <span class="badge bg-<%= transaction.status === 'Completed' ? 'success' : transaction.status === 'Pending' ? 'warning' : 'danger' %>">
                                                        <%= transaction.status %>
                                                    </span>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        <% } else { %>
                            <div class="text-center py-5">
                                <div class="display-6 text-muted mb-3">ðŸ“‹</div>
                                <h5 class="text-muted">No transactions yet</h5>
                                <p class="text-muted">Your payment history will appear here</p>
                            </div>
                        <% } %>
                    </div>
                </div>

                <!-- Membership Plans -->
                <div class="card mb-5">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-award me-2"></i>Membership Plans</h5>
                        <% if (currentSubscription) { %>
                            <span class="badge bg-success">Active: <%= currentSubscription.plan_name %></span>
                        <% } %>
                    </div>
                    <div class="card-body">
                        <% if (currentSubscription) { %>
                            <div class="alert alert-success d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <i class="bi bi-check-circle me-2"></i>
                                    <strong>Current Plan:</strong> <%= currentSubscription.plan_name %> 
                                    <small class="text-muted">(Active since <%= new Date(currentSubscription.start_date).toLocaleDateString() %>)</small>
                                </div>
                                <form method="POST" action="/billing/cancel-plan" style="display: inline;" onsubmit="return confirm('Are you sure you want to cancel your current membership plan? This action cannot be undone.')">
                                    <button type="submit" class="btn btn-outline-danger btn-sm">
                                        <i class="bi bi-x-circle me-1"></i>Cancel Plan
                                    </button>
                                </form>
                            </div>
                        <% } %>
                        
                        <div class="row g-4">
                            <% if (membershipPlans && membershipPlans.length > 0) { %>
                                <% membershipPlans.forEach(function(plan) { %>
                                    <div class="col-md-4">
                                        <div class="card h-100 <%= plan.plan_name === 'Premium' ? 'border-primary' : '' %>">
                                            <div class="card-body text-center d-flex flex-column">
                                                <h5 class="card-title text-<%= plan.plan_name === 'Basic' ? 'success' : plan.plan_name === 'Premium' ? 'primary' : 'warning' %>">
                                                    <%= plan.plan_name %>
                                                </h5>
                                                <div class="display-6 text-<%= plan.plan_name === 'Basic' ? 'success' : plan.plan_name === 'Premium' ? 'primary' : 'warning' %> fw-bold">
                                                    $<%= parseFloat(plan.price).toFixed(0) %>
                                                </div>
                                                <p class="text-muted">/month</p>
                                                <ul class="list-unstyled flex-grow-1">
                                                    <% if (plan.features) { %>
                                                        <% plan.features.split(',').forEach(function(feature) { %>
                                                            <li>âœ“ <%= feature.trim() %></li>
                                                        <% }); %>
                                                    <% } %>
                                                </ul>
                                                <% if (currentSubscription && currentSubscription.plan_id == plan.plan_id) { %>
                                                    <button class="btn btn-success mt-auto" disabled>
                                                        <i class="bi bi-check-circle me-1"></i>Current Plan
                                                    </button>
                                                <% } else { %>
                                                    <form method="POST" action="<%= currentSubscription ? '/billing/switch-plan' : '/billing/select-plan' %>" style="display: inline;">
                                                        <input type="hidden" name="planId" value="<%= plan.plan_id %>">
                                                        <button type="submit" class="btn btn-outline-<%= plan.plan_name === 'Basic' ? 'success' : plan.plan_name === 'Premium' ? 'primary' : 'warning' %> mt-auto">
                                                            <% if (currentSubscription) { %>
                                                                Switch to <%= plan.plan_name %>
                                                            <% } else { %>
                                                                Select Plan
                                                            <% } %>
                                                        </button>
                                                    </form>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                            <% } else { %>
                                <div class="col-md-4">
                                    <div class="card h-100">
                                        <div class="card-body text-center d-flex flex-column">
                                            <h5 class="card-title text-success">Basic</h5>
                                            <div class="display-6 text-success fw-bold">$39</div>
                                            <p class="text-muted">/month</p>
                                            <ul class="list-unstyled flex-grow-1">
                                                <li>âœ“ Gym Access</li>
                                                <li>âœ“ Basic Equipment</li>
                                                <li>âœ“ Locker Room</li>
                                            </ul>
                                            <form method="POST" action="/billing/select-plan" style="display: inline;">
                                                <input type="hidden" name="planId" value="1">
                                                <button type="submit" class="btn btn-outline-success mt-auto">Select Plan</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="card h-100 border-primary">
                                        <div class="card-body text-center d-flex flex-column">
                                            <h5 class="card-title text-primary">Premium</h5>
                                            <div class="display-6 text-primary fw-bold">$79</div>
                                            <p class="text-muted">/month</p>
                                            <ul class="list-unstyled flex-grow-1">
                                                <li>âœ“ All Basic Features</li>
                                                <li>âœ“ 24/7 Access to Gym</li>
                                                <li>âœ“ Personal Training (2/month)</li>
                                                <li>âœ“ Nutrition Consultation</li>
                                            </ul>
                                            <form method="POST" action="/billing/select-plan" style="display: inline;">
                                                <input type="hidden" name="planId" value="2">
                                                <button type="submit" class="btn btn-outline-primary mt-auto">Select Plan</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="card h-100">
                                        <div class="card-body text-center d-flex flex-column">
                                            <h5 class="card-title text-warning">Elite</h5>
                                            <div class="display-6 text-warning fw-bold">$129</div>
                                            <p class="text-muted">/month</p>
                                            <ul class="list-unstyled flex-grow-1">
                                                <li>âœ“ All Premium Features</li>
                                                <li>âœ“ Unlimited Personal Training</li>
                                                <li>âœ“ VIP Locker Room</li>
                                                <li>âœ“ Guest Passes (5/month)</li>
                                                <li>âœ“ Priority Booking</li>
                                            </ul>
                                            <form method="POST" action="/billing/select-plan" style="display: inline;">
                                                <input type="hidden" name="planId" value="3">
                                                <button type="submit" class="btn btn-outline-warning mt-auto">Select Plan</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Payment Method Modal -->
    <div class="modal fade" id="addPaymentMethodModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content text-dark">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Add Payment Method</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addPaymentMethodForm" method="POST" action="/billing/payment-methods">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="methodType" class="form-label">Payment Method Type</label>
                            <select class="form-select" id="methodType" name="methodType" required>
                                <option value="">Select payment method</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="Debit Card">Debit Card</option>
                                <option value="PayPal">PayPal</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>
                        
                        <div id="cardDetails" style="display: none;">
                            <div class="mb-3">
                                <label for="cardNumber" class="form-label">Card Number</label>
                                <input type="text" class="form-control" id="cardNumber" name="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label for="expiryDate" class="form-label">Expiry Date</label>
                                        <input type="text" class="form-control" id="expiryDate" name="expiryDate" placeholder="MM/YY" maxlength="5">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label for="cvv" class="form-label">CVV</label>
                                        <input type="text" class="form-control" id="cvv" name="cvv" placeholder="123" maxlength="4">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="cardholderName" class="form-label">Cardholder Name</label>
                                <input type="text" class="form-control" id="cardholderName" name="cardholderName" placeholder="John Doe">
                            </div>
                        </div>
                        
                        <div id="paypalDetails" style="display: none;">
                            <div class="mb-3">
                                <label for="paypalEmail" class="form-label">PayPal Email</label>
                                <input type="email" class="form-control" id="paypalEmail" name="paypalEmail" placeholder="email@example.com">
                            </div>
                        </div>
                        
                        <div id="bankDetails" style="display: none;">
                            <div class="mb-3">
                                <label for="accountNumber" class="form-label">Account Number</label>
                                <input type="text" class="form-control" id="accountNumber" name="accountNumber" placeholder="123456789">
                            </div>
                            <div class="mb-3">
                                <label for="bankName" class="form-label">Bank Name</label>
                                <input type="text" class="form-control" id="bankName" name="bankName" placeholder="Bank Name">
                            </div>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="setAsDefault" name="setAsDefault">
                            <label class="form-check-label" for="setAsDefault">
                                Set as default payment method
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Payment Method</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Funds Modal -->
    <div class="modal fade" id="addFundsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content text-dark">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-wallet-fill me-2"></i>Add Funds</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addFundsForm" method="POST" action="/billing/add-funds">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="fundAmount" class="form-label">Amount to Add</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="fundAmount" name="amount" placeholder="0.00" min="1" step="0.01" required>
                            </div>
                        </div>
                        
                        <% if (paymentMethods && paymentMethods.length > 0) { %>
                            <div class="mb-3">
                                <label for="paymentMethodSelect" class="form-label">Payment Method</label>
                                <select class="form-select" id="paymentMethodSelect" name="paymentMethodId" required>
                                    <% paymentMethods.forEach(function(method) { %>
                                        <option value="<%= method.payment_method_id %>" <%= method.is_default ? 'selected' : '' %>>
                                            <%= method.method_type %>
                                            <% if (method.card_number_last4) { %>
                                                - â€¢â€¢â€¢â€¢ <%= method.card_number_last4 %>
                                            <% } %>
                                            <% if (method.is_default) { %> (Default)<% } %>
                                        </option>
                                    <% }); %>
                                </select>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Funds will be added to your account immediately after confirmation.
                            </div>
                        <% } else { %>
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                You need to add a payment method first before you can add funds.
                            </div>
                        <% } %>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <% if (paymentMethods && paymentMethods.length > 0) { %>
                            <button type="submit" class="btn btn-success">Add Funds</button>
                        <% } else { %>
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#addPaymentMethodModal">
                                Add Payment Method First
                            </button>
                        <% } %>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Payment method type change handler (essential for UI)
        document.getElementById('methodType').addEventListener('change', function() {
            const cardDetails = document.getElementById('cardDetails');
            const paypalDetails = document.getElementById('paypalDetails');
            const bankDetails = document.getElementById('bankDetails');
            
            // Reset all required fields
            ['cardNumber', 'expiryDate', 'cvv', 'cardholderName', 'paypalEmail', 'accountNumber', 'bankName'].forEach(id => {
                document.getElementById(id).required = false;
            });
            
            // Hide all details
            cardDetails.style.display = 'none';
            paypalDetails.style.display = 'none';
            bankDetails.style.display = 'none';
            
            // Show relevant details and set required fields
            if (this.value === 'Credit Card' || this.value === 'Debit Card') {
                cardDetails.style.display = 'block';
                ['cardNumber', 'expiryDate', 'cvv', 'cardholderName'].forEach(id => {
                    document.getElementById(id).required = true;
                });
            } else if (this.value === 'PayPal') {
                paypalDetails.style.display = 'block';
                document.getElementById('paypalEmail').required = true;
            } else if (this.value === 'Bank Transfer') {
                bankDetails.style.display = 'block';
                ['accountNumber', 'bankName'].forEach(id => {
                    document.getElementById(id).required = true;
                });
            }
        });

        // Input formatting for better UX
        document.getElementById('cardNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
            e.target.value = value.match(/.{1,4}/g)?.join(' ') || value;
        });

        document.getElementById('expiryDate').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });

        document.getElementById('cvv').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });

        // Handle add funds form submission with AJAX
        document.getElementById('addFundsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            
            // Remove any existing alerts in the modal
            const existingAlerts = document.querySelectorAll('#addFundsModal .alert');
            existingAlerts.forEach(alert => alert.remove());
            
            // Disable submit button and show loading state
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>Processing...';
            
            // Convert FormData to regular object for JSON
            const data = {
                amount: formData.get('amount'),
                paymentMethodId: formData.get('paymentMethodId')
            };
            
            console.log('Submitting form with data:', data);
            
            fetch('/billing/add-funds', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                
                if (data.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addFundsModal'));
                    modal.hide();
                    
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        <i class="bi bi-check-circle-fill me-2"></i>${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    
                    // Insert alert at the top of the container
                    const container = document.querySelector('.container.py-5 .row .col-md-12');
                    container.insertBefore(alertDiv, container.children[1]);
                    
                    // Reset form
                    this.reset();
                    
                    // Reload page to update wallet balance
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    // Show error message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        <i class="bi bi-exclamation-circle-fill me-2"></i>${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    
                    // Insert alert in modal body
                    const modalBody = document.querySelector('#addFundsModal .modal-body');
                    modalBody.insertBefore(alertDiv, modalBody.firstChild);
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack
                });
                
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="bi bi-exclamation-circle-fill me-2"></i>Network error: ${error.message}. Please check your connection and try again.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // Insert alert in modal body
                const modalBody = document.querySelector('#addFundsModal .modal-body');
                modalBody.insertBefore(alertDiv, modalBody.firstChild);
            })
            .finally(() => {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            });
        });

        // Handle membership plan form submissions with AJAX
        document.addEventListener('DOMContentLoaded', function() {
            // Handle all membership plan forms (select-plan, switch-plan, and cancel-plan)
            const membershipForms = document.querySelectorAll('form[action*="/billing/select-plan"], form[action*="/billing/switch-plan"], form[action*="/billing/cancel-plan"]');
            
            membershipForms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const submitButton = this.querySelector('button[type="submit"]');
                    const originalText = submitButton.textContent;
                    const formData = new FormData(this);
                    const action = this.getAttribute('action');
                    
                    // Special handling for cancel-plan (needs confirmation)
                    if (action.includes('cancel-plan')) {
                        const confirmed = confirm('Are you sure you want to cancel your current membership plan? This action cannot be undone.');
                        if (!confirmed) {
                            return; // Don't proceed if user cancels
                        }
                    }
                    
                    // Disable submit button and show loading state
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>Processing...';
                    
                    // Convert FormData to JSON
                    const data = {};
                    if (formData.get('planId')) {
                        data.planId = formData.get('planId');
                    }
                    
                    console.log('Submitting membership plan form:', {
                        action: action,
                        data: data
                    });
                    
                    fetch(action, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => {
                        console.log('Response status:', response.status);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        return response.json();
                    })
                    .then(data => {
                        console.log('Response data:', data);
                        
                        if (data.success) {
                            // Show success message
                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert alert-success alert-dismissible fade show';
                            alertDiv.innerHTML = `
                                <i class="bi bi-check-circle-fill me-2"></i>${data.message}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            `;
                            
                            // Insert alert at the top of the container
                            const container = document.querySelector('.container.py-5 .row .col-md-12');
                            container.insertBefore(alertDiv, container.children[1]);
                            
                            // Reload page to update the membership plan display
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                        } else {
                            // Show error message
                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                            alertDiv.innerHTML = `
                                <i class="bi bi-exclamation-circle-fill me-2"></i>${data.message}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            `;
                            
                            // Insert alert at the top of the container
                            const container = document.querySelector('.container.py-5 .row .col-md-12');
                            container.insertBefore(alertDiv, container.children[1]);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                        alertDiv.innerHTML = `
                            <i class="bi bi-exclamation-circle-fill me-2"></i>Network error: ${error.message}. Please check your connection and try again.
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        
                        // Insert alert at the top of the container
                        const container = document.querySelector('.container.py-5 .row .col-md-12');
                        container.insertBefore(alertDiv, container.children[1]);
                    })
                    .finally(() => {
                        // Re-enable submit button
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                    });
                });
            });
        });
    </script>
</body>
</html>
