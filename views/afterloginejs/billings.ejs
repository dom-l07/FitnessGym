<!DOCTYPE html>
<html>
<head>
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <%- include('../partials/navbar') %>

    <div class="container py-5">
        <div class="row">
            <div class="col-md-12">
                <h1 class="h3 text-primary fw-bold mb-4">Billing & Payments</h1>
                
                <% if (messages && messages.length > 0) { %>
                    <div class="alert alert-success rounded-3 mb-4">
                        <% messages.forEach(function(message) { %>
                            <p class="mb-0"><i class="bi bi-check-circle-fill me-2"></i><%= message %></p>
                        <% }); %>
                    </div>
                <% } %>
                
                <% if (errors && errors.length > 0) { %>
                    <div class="alert alert-danger rounded-3 mb-4">
                        <% errors.forEach(function(error) { %>
                            <p class="mb-0"><i class="bi bi-exclamation-circle-fill me-2"></i><%= error %></p>
                        <% }); %>
                    </div>
                <% } %>

                <!-- Payment Methods Section -->
                <div class="row g-4 mb-5">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-credit-card me-2"></i>Payment Methods</h5>
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addPaymentMethodModal">
                                        <i class="bi bi-plus-circle me-1"></i>Add
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div id="paymentMethodsList" style="max-height: 200px; overflow-y: auto;">
                                    <% if (paymentMethods && paymentMethods.length > 0) { %>
                                        <% paymentMethods.forEach(function(method, index) { %>
                                            <div class="d-flex align-items-center justify-content-between p-3 payment-method-item <%= index < paymentMethods.length - 1 ? 'border-bottom' : '' %>">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-<%= method.method_type === 'Credit Card' ? 'credit-card' : method.method_type === 'Debit Card' ? 'credit-card-2-back' : method.method_type === 'PayPal' ? 'paypal' : 'bank' %> me-3 text-primary"></i>
                                                    <div>
                                                        <div class="fw-medium"><%= method.method_type %></div>
                                                        <% if (method.card_number_last4) { %>
                                                            <small class="text-muted">â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ <%= method.card_number_last4 %></small>
                                                        <% } %>
                                                        <% if (method.paypal_email) { %>
                                                            <small class="text-muted"><%= method.paypal_email %></small>
                                                        <% } %>
                                                        <% if (method.bank_name) { %>
                                                            <small class="text-muted"><%= method.bank_name %></small>
                                                        <% } %>
                                                        <% if (method.is_default) { %>
                                                            <span class="badge bg-success ms-2">Default</span>
                                                        <% } %>
                                                    </div>
                                                </div>
                                                <div>
                                                    <% if (!method.is_default) { %>
                                                        <button class="btn btn-sm btn-outline-primary me-1" onclick="setDefaultPaymentMethod(<%= method.payment_method_id %>)">
                                                            Set Default
                                                        </button>
                                                    <% } %>
                                                    <button class="btn btn-sm btn-outline-danger" onclick="deletePaymentMethod(<%= method.payment_method_id %>)">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        <% }); %>
                                    <% } else { %>
                                        <div class="text-center py-4">
                                            <div class="display-6 text-muted mb-3">ðŸ’³</div>
                                            <p class="text-muted">No payment methods added yet</p>
                                            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addPaymentMethodModal">
                                                Add Payment Method
                                            </button>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-wallet me-2"></i>Account Balance</h5>
                                <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addFundsModal">
                                    <i class="bi bi-plus-circle me-1"></i>Add Funds
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="text-center py-4">
                                    <h2 class="text-success fw-bold">$<%= wallet ? parseFloat(wallet.balance).toFixed(2) : '0.00' %></h2>
                                    <p class="text-muted">Current Balance</p>
                                    <% if (paymentMethods && paymentMethods.length > 0) { %>
                                        <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#addFundsModal">
                                            Add Funds
                                        </button>
                                    <% } else { %>
                                        <p class="text-muted small">Add a payment method to add funds</p>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="card mb-5">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Transactions</h5>
                    </div>
                    <div class="card-body">
                        <% if (transactions && transactions.length > 0) { %>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Description</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% transactions.forEach(function(transaction) { %>
                                            <tr>
                                                <td><%= new Date(transaction.transaction_date).toLocaleDateString() %></td>
                                                <td>
                                                    <span class="badge bg-<%= transaction.transaction_type === 'Add Funds' ? 'success' : transaction.transaction_type === 'Payment' ? 'primary' : 'info' %>">
                                                        <%= transaction.transaction_type %>
                                                    </span>
                                                </td>
                                                <td><%= transaction.description || '-' %></td>
                                                <td class="<%= transaction.transaction_type === 'Add Funds' || transaction.transaction_type === 'Refund' ? 'text-success' : 'text-danger' %>">
                                                    <%= transaction.transaction_type === 'Add Funds' || transaction.transaction_type === 'Refund' ? '+' : '-' %>$<%= Math.abs(transaction.amount).toFixed(2) %>
                                                </td>
                                                <td>
                                                    <span class="badge bg-<%= transaction.status === 'Completed' ? 'success' : transaction.status === 'Pending' ? 'warning' : 'danger' %>">
                                                        <%= transaction.status %>
                                                    </span>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        <% } else { %>
                            <div class="text-center py-5">
                                <div class="display-6 text-muted mb-3">ðŸ“‹</div>
                                <h5 class="text-muted">No transactions yet</h5>
                                <p class="text-muted">Your payment history will appear here</p>
                            </div>
                        <% } %>
                    </div>
                </div>

                <!-- Membership Plans -->
                <div class="card mb-5">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-award me-2"></i>Membership Plans</h5>
                        <% if (currentSubscription) { %>
                            <span class="badge bg-success">Active: <%= currentSubscription.plan_name %></span>
                        <% } %>
                    </div>
                    <div class="card-body">
                        <% if (currentSubscription) { %>
                            <div class="alert alert-success d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <i class="bi bi-check-circle me-2"></i>
                                    <strong>Current Plan:</strong> <%= currentSubscription.plan_name %> 
                                    <small class="text-muted">(Active since <%= new Date(currentSubscription.start_date).toLocaleDateString() %>)</small>
                                </div>
                                <button class="btn btn-outline-danger btn-sm" onclick="cancelPlan()">
                                    <i class="bi bi-x-circle me-1"></i>Cancel Plan
                                </button>
                            </div>
                        <% } %>
                        
                        <div class="row g-4">
                            <% if (membershipPlans && membershipPlans.length > 0) { %>
                                <% membershipPlans.forEach(function(plan) { %>
                                    <div class="col-md-4">
                                        <div class="card h-100 <%= plan.plan_name === 'Premium' ? 'border-primary' : '' %>">
                                            <div class="card-body text-center d-flex flex-column">
                                                <h5 class="card-title text-<%= plan.plan_name === 'Basic' ? 'success' : plan.plan_name === 'Premium' ? 'primary' : 'warning' %>">
                                                    <%= plan.plan_name %>
                                                </h5>
                                                <div class="display-6 text-<%= plan.plan_name === 'Basic' ? 'success' : plan.plan_name === 'Premium' ? 'primary' : 'warning' %> fw-bold">
                                                    $<%= parseFloat(plan.price).toFixed(0) %>
                                                </div>
                                                <p class="text-muted">/month</p>
                                                <ul class="list-unstyled flex-grow-1">
                                                    <% if (plan.features) { %>
                                                        <% plan.features.split(',').forEach(function(feature) { %>
                                                            <li>âœ“ <%= feature.trim() %></li>
                                                        <% }); %>
                                                    <% } %>
                                                </ul>
                                                <% if (currentSubscription && currentSubscription.plan_id == plan.plan_id) { %>
                                                    <button class="btn btn-success mt-auto" disabled>
                                                        <i class="bi bi-check-circle me-1"></i>Current Plan
                                                    </button>
                                                <% } else if (currentSubscription) { %>
                                                    <button class="btn btn-outline-secondary mt-auto" disabled>
                                                        Cancel Current Plan First
                                                    </button>
                                                <% } else { %>
                                                    <button class="btn btn-outline-<%= plan.plan_name === 'Basic' ? 'success' : plan.plan_name === 'Premium' ? 'primary' : 'warning' %> mt-auto" 
                                                            onclick="selectPlan(<%= plan.plan_id %>, '<%= plan.plan_name %>', <%= plan.price %>)">
                                                        Select Plan
                                                    </button>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                            <% } else { %>
                                <div class="col-md-4">
                                    <div class="card h-100">
                                        <div class="card-body text-center d-flex flex-column">
                                            <h5 class="card-title text-success">Basic</h5>
                                            <div class="display-6 text-success fw-bold">$39</div>
                                            <p class="text-muted">/month</p>
                                            <ul class="list-unstyled flex-grow-1">
                                                <li>âœ“ Gym Access</li>
                                                <li>âœ“ Basic Equipment</li>
                                                <li>âœ“ Locker Room</li>
                                            </ul>
                                            <button class="btn btn-outline-success mt-auto" onclick="selectPlan(1, 'Basic', 39)">Select Plan</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="card h-100 border-primary">
                                        <div class="card-body text-center d-flex flex-column">
                                            <h5 class="card-title text-primary">Premium</h5>
                                            <div class="display-6 text-primary fw-bold">$79</div>
                                            <p class="text-muted">/month</p>
                                            <ul class="list-unstyled flex-grow-1">
                                                <li>âœ“ All Basic Features</li>
                                                <li>âœ“ 24/7 Access to Gym</li>
                                                <li>âœ“ Personal Training (2/month)</li>
                                                <li>âœ“ Nutrition Consultation</li>
                                            </ul>
                                            <button class="btn btn-outline-primary mt-auto" onclick="selectPlan(2, 'Premium', 79)">Select Plan</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="card h-100">
                                        <div class="card-body text-center d-flex flex-column">
                                            <h5 class="card-title text-warning">Elite</h5>
                                            <div class="display-6 text-warning fw-bold">$129</div>
                                            <p class="text-muted">/month</p>
                                            <ul class="list-unstyled flex-grow-1">
                                                <li>âœ“ All Premium Features</li>
                                                <li>âœ“ Unlimited Personal Training</li>
                                                <li>âœ“ VIP Locker Room</li>
                                                <li>âœ“ Guest Passes (5/month)</li>
                                                <li>âœ“ Priority Booking</li>
                                            </ul>
                                            <button class="btn btn-outline-warning mt-auto" onclick="selectPlan(3, 'Elite', 129)">Select Plan</button>
                                        </div>
                                    </div>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Payment Method Modal -->
    <div class="modal fade" id="addPaymentMethodModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content text-dark">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Add Payment Method</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addPaymentMethodForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="methodType" class="form-label">Payment Method Type</label>
                            <select class="form-select" id="methodType" name="methodType" required>
                                <option value="">Select payment method</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="Debit Card">Debit Card</option>
                                <option value="PayPal">PayPal</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>
                        
                        <div id="cardDetails" style="display: none;">
                            <div class="mb-3">
                                <label for="cardNumber" class="form-label">Card Number</label>
                                <input type="text" class="form-control" id="cardNumber" name="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label for="expiryDate" class="form-label">Expiry Date</label>
                                        <input type="text" class="form-control" id="expiryDate" name="expiryDate" placeholder="MM/YY" maxlength="5">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label for="cvv" class="form-label">CVV</label>
                                        <input type="text" class="form-control" id="cvv" name="cvv" placeholder="123" maxlength="4">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="cardholderName" class="form-label">Cardholder Name</label>
                                <input type="text" class="form-control" id="cardholderName" name="cardholderName" placeholder="John Doe">
                            </div>
                        </div>
                        
                        <div id="paypalDetails" style="display: none;">
                            <div class="mb-3">
                                <label for="paypalEmail" class="form-label">PayPal Email</label>
                                <input type="email" class="form-control" id="paypalEmail" name="paypalEmail" placeholder="email@example.com">
                            </div>
                        </div>
                        
                        <div id="bankDetails" style="display: none;">
                            <div class="mb-3">
                                <label for="accountNumber" class="form-label">Account Number</label>
                                <input type="text" class="form-control" id="accountNumber" name="accountNumber" placeholder="123456789">
                            </div>
                            <div class="mb-3">
                                <label for="bankName" class="form-label">Bank Name</label>
                                <input type="text" class="form-control" id="bankName" name="bankName" placeholder="Bank Name">
                            </div>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="setAsDefault" name="setAsDefault">
                            <label class="form-check-label" for="setAsDefault">
                                Set as default payment method
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Payment Method</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Funds Modal -->
    <div class="modal fade" id="addFundsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content text-dark">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-wallet-fill me-2"></i>Add Funds</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addFundsForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="fundAmount" class="form-label">Amount to Add</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="fundAmount" name="amount" placeholder="0.00" min="1" step="0.01" required>
                            </div>
                        </div>
                        
                        <% if (paymentMethods && paymentMethods.length > 0) { %>
                            <div class="mb-3">
                                <label for="paymentMethodSelect" class="form-label">Payment Method</label>
                                <select class="form-select" id="paymentMethodSelect" name="paymentMethodId" required>
                                    <% paymentMethods.forEach(function(method) { %>
                                        <option value="<%= method.payment_method_id %>" <%= method.is_default ? 'selected' : '' %>>
                                            <%= method.method_type %>
                                            <% if (method.card_number_last4) { %>
                                                - â€¢â€¢â€¢â€¢ <%= method.card_number_last4 %>
                                            <% } %>
                                            <% if (method.is_default) { %> (Default)<% } %>
                                        </option>
                                    <% }); %>
                                </select>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Funds will be added to your account immediately after confirmation.
                            </div>
                        <% } else { %>
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                You need to add a payment method first before you can add funds.
                            </div>
                        <% } %>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <% if (paymentMethods && paymentMethods.length > 0) { %>
                            <button type="submit" class="btn btn-success">Add Funds</button>
                        <% } else { %>
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#addPaymentMethodModal">
                                Add Payment Method First
                            </button>
                        <% } %>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Plan Selection Confirmation Modal -->
    <div class="modal fade" id="planConfirmationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-credit-card me-2"></i>Confirm Plan Selection</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <div class="display-6 mb-3">ðŸ’³</div>
                        <h6>You are about to subscribe to:</h6>
                        <h4 id="selectedPlanName" class="text-primary"></h4>
                        <p class="text-muted mb-3">Monthly subscription</p>
                        <div class="alert alert-info">
                            <div class="d-flex justify-content-between">
                                <span>Plan Cost:</span>
                                <span id="selectedPlanPrice" class="fw-bold"></span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Current Balance:</span>
                                <span class="fw-bold">$<%= wallet ? parseFloat(wallet.balance).toFixed(2) : '0.00' %></span>
                            </div>
                            <hr class="my-2">
                            <div class="d-flex justify-content-between">
                                <span>Remaining Balance:</span>
                                <span id="remainingBalance" class="fw-bold"></span>
                            </div>
                        </div>
                        <p class="text-muted small">This subscription will be automatically renewed monthly. You can cancel anytime.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmPlanBtn">
                        <i class="bi bi-check-circle me-1"></i>Confirm & Subscribe
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Payment method type change handler
        document.getElementById('methodType').addEventListener('change', function() {
            const cardDetails = document.getElementById('cardDetails');
            const paypalDetails = document.getElementById('paypalDetails');
            const bankDetails = document.getElementById('bankDetails');
            
            // Reset all required fields
            document.getElementById('cardNumber').required = false;
            document.getElementById('expiryDate').required = false;
            document.getElementById('cvv').required = false;
            document.getElementById('cardholderName').required = false;
            document.getElementById('paypalEmail').required = false;
            document.getElementById('accountNumber').required = false;
            document.getElementById('bankName').required = false;
            
            // Hide all details
            cardDetails.style.display = 'none';
            paypalDetails.style.display = 'none';
            bankDetails.style.display = 'none';
            
            // Show relevant details and set required fields
            if (this.value === 'Credit Card' || this.value === 'Debit Card') {
                cardDetails.style.display = 'block';
                document.getElementById('cardNumber').required = true;
                document.getElementById('expiryDate').required = true;
                document.getElementById('cvv').required = true;
                document.getElementById('cardholderName').required = true;
            } else if (this.value === 'PayPal') {
                paypalDetails.style.display = 'block';
                document.getElementById('paypalEmail').required = true;
            } else if (this.value === 'Bank Transfer') {
                bankDetails.style.display = 'block';
                document.getElementById('accountNumber').required = true;
                document.getElementById('bankName').required = true;
            }
        });

        // Card number formatting
        document.getElementById('cardNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ');
            e.target.value = formattedValue || value;
        });

        // Expiry date formatting
        document.getElementById('expiryDate').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });

        // CVV validation
        document.getElementById('cvv').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });

        // Add payment method form submission
        document.getElementById('addPaymentMethodForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            fetch('/billing/payment-methods', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while adding the payment method');
            });
        });

        // Add funds form submission
        document.getElementById('addFundsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('fundAmount').value);
            const paymentMethodId = document.getElementById('paymentMethodSelect').value;
            
            // Validate inputs
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount greater than 0');
                return;
            }
            
            if (!paymentMethodId) {
                alert('Please select a payment method');
                return;
            }
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            fetch('/billing/add-funds', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Funds added successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while adding funds');
            });
        });

        // Set default payment method
        function setDefaultPaymentMethod(paymentMethodId) {
            fetch(`/billing/payment-methods/${paymentMethodId}/set-default`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while setting default payment method');
            });
        }

        // Delete payment method
        function deletePaymentMethod(paymentMethodId) {
            if (confirm('Are you sure you want to delete this payment method?')) {
                fetch(`/billing/payment-methods/${paymentMethodId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the payment method');
                });
            }
        }

        // Select membership plan
        function selectPlan(planId, planName, planPrice) {
            const currentBalance = <%= wallet ? parseFloat(wallet.balance) : 0 %>;
            const remainingBalance = currentBalance - planPrice;
            
            // Check if user has sufficient funds
            if (currentBalance < planPrice) {
                alert(`Insufficient funds! You need $${planPrice.toFixed(2)} but only have $${currentBalance.toFixed(2)} in your wallet. Please add funds first.`);
                return;
            }
            
            // Show confirmation modal
            document.getElementById('selectedPlanName').textContent = planName;
            document.getElementById('selectedPlanPrice').textContent = '$' + planPrice.toFixed(2);
            document.getElementById('remainingBalance').textContent = '$' + remainingBalance.toFixed(2);
            document.getElementById('remainingBalance').className = remainingBalance >= 0 ? 'fw-bold text-success' : 'fw-bold text-danger';
            
            // Store plan details for confirmation
            document.getElementById('confirmPlanBtn').setAttribute('data-plan-id', planId);
            document.getElementById('confirmPlanBtn').setAttribute('data-plan-name', planName);
            document.getElementById('confirmPlanBtn').setAttribute('data-plan-price', planPrice);
            
            const modal = new bootstrap.Modal(document.getElementById('planConfirmationModal'));
            modal.show();
        }

        // Confirm plan selection
        document.getElementById('confirmPlanBtn').addEventListener('click', function() {
            const planId = this.getAttribute('data-plan-id');
            const planName = this.getAttribute('data-plan-name');
            const planPrice = this.getAttribute('data-plan-price');
            
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
            
            fetch('/billing/select-plan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ planId: planId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-check-circle me-1"></i>Confirm & Subscribe';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while selecting the plan');
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-check-circle me-1"></i>Confirm & Subscribe';
            });
        });

        // Cancel membership plan
        function cancelPlan() {
            if (confirm('Are you sure you want to cancel your current membership plan? This action cannot be undone.')) {
                fetch('/billing/cancel-plan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while cancelling the plan');
                });
            }
        }
    </script>
</body>
</html>
